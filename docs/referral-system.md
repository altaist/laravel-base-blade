# Система реферальных ссылок

## Описание

Гибридная система реферальных ссылок, которая позволяет пользователям создавать множественные реферальные ссылки с различными настройками и отслеживать их эффективность.

## Основные возможности

- ✅ Создание множественных реферальных ссылок для одного пользователя
- ✅ Различные типы ссылок (социальные сети, мессенджеры, офлайн, пользовательские)
- ✅ Настройка максимального количества использований
- ✅ Настройка срока действия ссылок
- ✅ Гибридное отслеживание (cookie + fingerprint)
- ✅ Долговременное хранение (месяц)
- ✅ Интеграция со всеми типами регистрации (email, Telegram, auth-link)
- ✅ Детальная статистика и аналитика

## API Endpoints

### Публичные маршруты

- `GET /ref/{code}` - Переход по реферальной ссылке

### Защищенные маршруты (требуют авторизации)

- `GET /referral/` - Список реферальных ссылок пользователя
- `POST /referral/` - Создание новой реферальной ссылки
- `GET /referral/stats` - Статистика рефералов
- `GET /referral/referred-users` - Список приглашенных пользователей
- `PUT /referral/{link}` - Обновление настроек ссылки
- `POST /referral/{link}/activate` - Активация ссылки
- `POST /referral/{link}/deactivate` - Деактивация ссылки

## Структура данных

### ReferralLink (Реферальные ссылки)

```php
- id: ID ссылки
- user_id: ID владельца ссылки
- code: Уникальный код ссылки (8 символов)
- name: Название ссылки
- type: Тип ссылки (social, messenger, offline, custom)
- is_active: Активна ли ссылка
- max_uses: Максимальное количество использований
- current_uses: Текущее количество использований
- expires_at: Срок действия ссылки
```

### Referral (Рефералы)

```php
- id: ID реферала
- referral_link_id: ID реферальной ссылки
- referrer_id: ID пользователя-реферера
- referred_id: ID приглашенного пользователя (nullable)
- visitor_cookie_id: ID cookie посетителя
- visitor_fingerprint: Fingerprint посетителя
- visitor_ip: IP адрес посетителя
- user_agent: User Agent браузера
- status: Статус (pending, completed, expired)
- expires_at: Срок действия возможности регистрации
```

## Команды Artisan

### Очистка истекших рефералов

```bash
php artisan referral:cleanup
```

### Создание ссылок для существующих пользователей

```bash
php artisan referral:generate-codes
php artisan referral:generate-codes --force  # Принудительно для всех
```

## Примеры использования

### Создание реферальной ссылки

```php
POST /referral/
{
    "name": "Instagram",
    "type": "social",
    "max_uses": 100,
    "expires_at": "2024-12-31 23:59:59"
}
```

### Получение статистики

```php
GET /referral/stats

Response:
{
    "success": true,
    "data": {
        "total_links": 3,
        "active_links": 2,
        "total_clicks": 45,
        "total_registrations": 12,
        "total_pending": 2,
        "overall_conversion_rate": 26.67
    }
}
```

## Логика работы

1. **Переход по ссылке**: Создается запись Referral с cookie ID и fingerprint
2. **Регистрация**: Система ищет активный реферал по cookie/fingerprint
3. **Завершение**: Referral помечается как completed, увеличивается счетчик ссылки

## Безопасность

- Уникальные коды ссылок с проверкой коллизий
- Валидация срока действия
- Защита от подделки через fingerprint
- Логирование всех операций

## Мониторинг

Все операции логируются в стандартный лог Laravel с контекстом:
- Переходы по ссылкам
- Регистрации по рефералам
- Ошибки обработки
- Статистика использования
